---
title: "Export Migration Configuration Entities into a Module"
url: "https://drupalize.me/tutorial/export-migration-configuration-entities-module?p=3116"
guide: "[[learn-migrate-drupal]]"
order: 18
---

# Export Migration Configuration Entities into a Module

## Content

If you want to modify the Drupal-to-Drupal migrations created by Migrate Upgrade you'll need to export the Migrate Plus configuration entities, convert the ones you want to customize to standard migration *.yml* files, and put them into a custom module. Then, you can make edits the YAML definition of the migration, and keep your customizations in Git.

We recommend creating a new module to house the code that makes up your custom Drupal-to-Drupal migration.

In this tutorial we'll:

- Create a new module
- Export the migration configuration entities generated by `drush migrate-upgrade` as YAML files
- Copy the files that represent the migrations we're interested in into our new module
- Customize the copied files

By the end of this tutorial you should have a new module that contains the starting migration YAML files for your custom migration.

## Goal

Export Migrate Plus configuration entities into YAML files that can be stored in a module and reused.

## Prerequisites

- [Custom Drupal-to-Drupal Migrations](https://drupalize.me/tutorial/custom-drupal-drupal-migrations)
- [Migration-Related Contributed Modules](https://drupalize.me/tutorial/migration-related-contributed-modules)
- [Inspect Configuration with Drush](https://drupalize.me/tutorial/inspect-configuration-drush)
- [Synchronize Configuration with Drush](https://drupalize.me/tutorial/synchronize-configuration-drush)
- [Overview: Info Files for Drupal Modules](https://drupalize.me/tutorial/overview-info-files-drupal-modules)

## Why do this?

At the end of this we'll end up with some migration YAML files that are no different than if we had [written a custom migration](https://drupalize.me/tutorial/write-custom-migration). However, rather than writing all the YAML from scratch we can use the automatically generated migrations as a starting point. This can save some typing. And is useful to learn more about the construction of Drupal-to-Drupal migrations.

But if you've done this a bunch of times, and you already know what source and destination plugins you want to use, and how to look up the field names for mapping, you can also write these by hand.

## Example code

Find the [complete example code from this tutorial on GitHub](https://github.com/DrupalizeMe/dmeblog_migrate).

Sprout Video

**Note**: Some Drush commands have changed in the latest version of Drush. See [Inspect Configuration with Drush](https://drupalize.me/tutorial/inspect-configuration-drush) for more information. The video also recommends putting the generated migrations in the *config/install/* directory of a custom module. But we have since changed our recommendation and now recommend the *migrations/* directory. Also, Drupal Console is no longer a recommended project because it is not actively maintained.

At this point you should have a bunch of configuration entities in your destination Drupal site that represent the migration from your previous version of Drupal to the latest version of Drupal. If you don't, refer to [Custom Drupal-to-Drupal migrations](https://drupalize.me/tutorial/custom-drupal-drupal-migrations) which walks through generating the migration configuration entities.

In our case, the one we're the most interested in is *upgrade\_d7\_node\_blog\_post*. It's the migration that represents moving the *blog\_post* content type from our Drupal 7 site into our destination Drupal site.

Note: Where applicable, Drush command examples use an alias that is compatible with both Drush 8, 9, and 10.

## What migrations should I include?

Migrations have the ability to declare a dependency, either required or optional, on other migrations. You need to make sure that you include all required dependencies, and any optional ones that make sense for your use case. We primarily want the content from *upgrade\_d7\_node\_blog\_post*. But we're also going to use *upgrade\_d7\_node\_type* to migrate the *blog\_post* content type, and *upgrade\_d7\_field*, and *upgrade\_d7\_field\_instance* to migrate the related field definitions.

For each migration that you know for sure you want, take a look at the existing configuration entity using something like `drush cget` and look at the list of dependencies. Then determine which of those dependencies you also need and add them to your list. (Note: `drush cget` is shorthand alias for both the Drush 8 command `drush config-get` and the Drush 9 command `drush config:get`.)

## Make a list

In our example we want to make copies of the *upgrade\_d7\_node\_blog\_post*, *upgrade\_d7\_node\_type*, *upgrade\_d7\_user\_role*, and other migration configuration entities we're interested in as YAML files.

Configuration entity names are prefixed with the name of the module that provides the configuration, followed by the configuration entity type, and finally the object name. So in our example the complete names for the configuration entities are:

- *migrate\_plus.migration.upgrade\_d7\_field*
- *migrate\_plus.migration.upgrade\_d7\_field\_instance*
- *migrate\_plus.migration.upgrade\_d7\_node\_blog\_post*
- *migrate\_plus.migration.upgrade\_d7\_node\_type*
- *migrate\_plus.migration.upgrade\_d7\_user*
- *migrate\_plus.migration.upgrade\_d7\_user\_role*

## Create a new module

Here's what we'll do next:

1. Create a new module.
2. Export Migrate Plus configuration entities to YAML files.
3. Convert the configuration entity YAML files to regular migraton YAML files in our module.
4. Customize the new migrations.

### Create a module info file

Start with an *.info.yml* file for our custom module. We'll call our module *dmeblog\_migrate*.

*modules/custom/dmeblog\_migrate/dmeblog\_migrate.info.yml*:

```
name: dmeblog_migrate
type: module
description: Migrate Drupalize.Me blog posts and authors
core_version_requirement: ^8 || ^9 || ^10
package: Custom
# Our module depends on Migrate Plus because we'll use migration configuration
# entities. We also have a soft-dependency on Migrate Tools since without it we
# can't actually execute our migrations. But, having it enabled isn't a
# requirement so we don't necessarily need to list it here.
dependencies:
  - migrate_plus
```

### Define a new migration group (optional)

You can skip this step, but we find it's helpful to group migrations together. Many migration-related Drush commands accept a `--group` flag which makes creating a migration group especially useful.

Creating a migrate group definition will enable you group all of your migrations together. These are defined as a configuration entity with the following naming convention: `migration_plus.migration_group.{group_name}`, where `{group_name}` is the unique ID you want to use for the group. We'll call ours *dmeblog\_migrate*. We could name it anything we want, but in order to not pollute the namespace we'll use the same name as our module here. So, keep in mind both the module, and the migration group, have the same name, *dmeblog\_migrate*.

Create *migrations/migrate\_plus.migration\_group.dmeblog\_migrate.yml*, and add the following content:

```
# The ID you use here is what we'll use as the group name elsewhere. And when
# using the --group flag in Drush commands like:
# drush migrate:status --group=dmeblog
id: dmeblog
label: DMeBlog
description: Migrate the Drupalize.Me Blog to D9.
source_type: Drupal 7
shared_configuration:
# This allows us to set the source key of the database to use in settings.php
  source:
    key: dmed7
```

### Run `drush migrate-upgrade` if you haven't already

If you haven't already done so you need to use Migrate Upgrade to create the configuration entities which we'll export in the next step.

Run the command below:

```
drush migrate-upgrade --configure-only --migration-prefix=d7_custom_
```

The `--configure-only` flag tells the command to generate the migration entities, but stop before executing them.

The `--migration-prefix` flag lets you keep the generated migrations separate from other runs of the same command. But also isn't necessarily needed because we're going to manually rename the files anyway.

### Export migration config entities to code

We'll export them to a temporary directory because when we do the export we'll get *all* of our site's configuration, but we really only want a handful of the resulting files. Once we've got the YAML files we need, we'll copy them into the *migrations/* sub-directory of our module.

Export all configuration into a temporary directory, locate the files you need in the temporary directory, and copy them into *modules/dmeblog\_migrate/migrations/*:

```
drush cex --destination=/tmp/migrate
```

Locate the files for each migration in the */tmp/migrate* directory and copy them into the *migrations/* directory of your custom module.

Or, export individual items one at a time:

```
# With Drush:
drush cget migrate_plus.migration.dmeblog_d7_node_blog_post > /path/to/dmeblog_migrate/migrations/migrate_plus.migration.upgrade_d7_node_blog_post.yml
```

Curious about what's going on here? Learn more in [Synchronize Configuration with Drush](https://drupalize.me/tutorial/synchronize-configuration-drush).

### Rename and edit the exported files

All of the YAML files can have the `migrate_plus.migration.` prefix removed.

In each of the *\*.yml* files that you copied, edit the file and change the `migration_group: migrate_drupal_7` to `migrate_group: {group_name}`, where `{group_name}` is the name of the group you created earlier, and in our case is `migrate_group: dmeblog_migrate`.

This:

```
id: upgrade_d7_node_blog_post
migration_group: upgrade_migrate
```

Should become:

```
# While not required, we like to set both the ID (below) and the filename
# (migrations/dmeblog_d7_node_blog_post.yml) to the same thing.
id: dmeblog_d7_node_blog_post
migration_group: dmeblog_migrate
```

Now remove the following lines from each *.yml* file:

```
uuid: 1234-ASDF-****
langcode: en
status: true
dependencies: {  }
```

These are all part of the configuration entity definition and not required once the migration is moved to the *migrations/* subdirectory.

Some migration YAML files will contain a list of required, or optional dependencies. You'll want to update the names of those as well.

### Results

In the end, you should end up with a handful of new YAML files in the *migrations/* directory of your module. In our case it looks like this:

```
modules/dmeblog_migrate/
├── dmeblog_migrate.info.yml
├── dmeblog_migrate.module (optional for now)
├── migrations
│   ├── dmeblog_d7_field.yml
│   ├── dmeblog_d7_field_instance.yml
│   ├── dmeblog_d7_node_blog_post.yml
│   ├── dmeblog_d7_node_type.yml
│   ├── dmeblog_d7_user.yml
│   ├── dmeblog_d7_user_role.yml
│   └── migrate_plus.migration_group.dmeblog_migrate.yml
```

### Clean-up leftover configuration entities

After exporting the configuration entities you want to keep, you should clean up the leftovers. During development we recommend keeping these around. We frequently end up re-exporting something, or just wanting to go back and reference what the generated migration looks like. But before you launch your site it's a good idea to cleanup this extra cruft.

Use a command like this to delete all existing *migrate\_plus.migration.\** configuration entities:

Using Drush 8:

```
drush config-list migrate_plus.migration | xargs -L 1 drush config-delete
drush cr -y
```

Using Drush 9+:

```
drush config:status --prefix='migrate_plus.migration' --format=list | xargs -L 1 drush config:delete
drush cr -y
```

### Install your new module

[Install the module](https://drupalize.me/tutorial/user-guide/config-install) that you created above.

Using Drush:

```
drush en dmeblog_migrate
```

(Replace `dmeblog_migrate` with the machine name of your module.)

You can [run these migrations just like any custom migration](https://drupalize.me/tutorial/run-custom-migrations).

## Customize your migration

At this point you can start customizing your migration further by editing the individual migration YAML files.

- Read about [writing custom migrations](https://drupalize.me/tutorial/write-custom-migration) to learn more about modifying the migration
- [Use `hook_migrate_prepare_row()` to limit the content types and fields that are migrated](https://drupalize.me/tutorial/use-hookmigratepreparerow) to just blog\_post and related fields
- [Write a new source plugin to limit the users migrated](https://drupalize.me/tutorial/customize-existing-source-plugin) to just those who have written a blog post

## Recap

In this tutorial we looked at how you can use Drush to export the configuration entities generated by the Migrate Plus module as YAML files. We then made some modifications to the exported YAML files in order to allow them to be included in a custom module, and thus version-controlled. Doing this ultimately makes it easier for us to reuse a custom migration and to collaborate with other developers working on the same migration.

## Further your understanding

- Create a list of the migrations and their dependencies that you'll need for your custom migration.
- What are the benefits of creating a new module and putting our migration code into the module? Can you think of any downsides?

## Additional resources

- [Example code from this tutorial](https://github.com/DrupalizeMe/dmeblog_migrate)
- This relies heavily on understanding [how configuration management works in Drupal](https://drupalize.me/series/configuration-management).
- [Inspect Configuration with Drush](https://drupalize.me/tutorial/inspect-configuration-drush)
- [Synchronize Configuration with Drush](https://drupalize.me/tutorial/synchronize-configuration-drush)
- Learn more about the use of the *config/install* directory in our tutorial on [providing default configuration](https://drupalize.me/tutorial/default-configuration-module) for a module.
- [Drupal User Guide: 4.3. Installing a Module](https://drupalize.me/tutorial/user-guide/config-install) (Drupalize.Me)

Was this helpful?

Yes

No

Any additional feedback?

Previous
[Create Migrations from Core Templates](/tutorial/create-migrations-core-templates?p=3116)

Next
[Customize an Existing Source Plugin](/tutorial/customize-existing-source-plugin?p=3116)

Clear History

Ask Drupalize.Me AI

close