---
title: "Make an Authenticated Request Using OAuth 2"
url: "https://drupalize.me/tutorial/make-authenticated-request-using-oauth-2?p=3279"
guide: "[[decoupled-headless-drupal]]"
---

# Make an Authenticated Request Using OAuth 2

## Content

In the previous tutorials, we learned to install and configure the Simple OAuth module. We also learned how to generate authentication tokens using different grants. In this tutorial, we will learn how to use a token to authenticate a request for a given Drupal user, and:

- Check if a particular route supports a specific type of authentication, `oauth2` in particular
- Send an authentication token, like the ones we acquired in [the previous tutorial](https://drupalize.me/tutorial/get-token-oauth-2-requests) in order to prove to Drupal that the request is made by a specific user

By the end of this tutorial you should be able to make authenticated requests, as a specific user, to your API.

## Goal

Use an OAuth 2 token to authenticate a request for a given Drupal user.

## Prerequisites

- [API Authentication and Authorization](https://drupalize.me/tutorial/make-authenticated-request-using-oauth-2)
- [Install and Configure Simple OAuth](https://drupalize.me/tutorial/install-and-configure-simple-oauth)
- [Get a Token for OAuth 2 Requests](https://drupalize.me/tutorial/get-token-oauth-2-requests)

## Video tutorial

Sprout Video

## Authenticated routes

Drupal core provides a new subsystem called [Authentication API](https://www.drupal.org/docs/8/api/authentication-api/overview). This subsystem allows anyone to define new ways that a request can be authenticated. In fact, the Simple OAuth module uses the Authentication API in order to add OAuth 2. Each different way to authenticate a request is called an *authentication provider*. Drupal core ships with the `cookie` and `basic_auth` authentication providers, but we can add more using custom code or contributed modules.

Each one of these authentication providers has a machine name identifier. This identifier is used by the routing system to enable the authentication provider in a given route. One common misconception is that when we install an authentication provider, we will be able to use it anywhere in Drupal to make authenticated requests. If we need a particular route to support a specific authentication method, we will need to enable it. To do so we need to add that machine name in the route definition, like in the following example:

```
oauth2_token.user_debug:
  path: '/oauth/debug'
  defaults:
    _controller: 'Drupal\simple_oauth_extras\Controller\DebugController::debug'
  methods: [GET]
  requirements:
    _access: 'TRUE'
    _format: 'json'
  options:
    _auth: ['oauth2']
    no_cache: TRUE
```

We can see that the authentication provider `oauth2` is listed under `options._auth` to enable OAuth 2 in `/oauth/debug`.

It is important to note that the `cookie` authentication provider is considered a *global* authentication provider. That means that even if `cookie` is not listed it will always be available under any route in Drupal.

While troubleshooting why our request is not authenticated like we expected, we should make sure that the authentication provider is enabled for that route. When dealing with decoupled applications it is worth noting that all the routes generated by the JSON:API module automatically support any provider available in the system, without any extra effort.

## Authenticate a request with a token

Once our route is set up to support OAuth 2, we can use the token we obtained in the [previous tutorial](https://drupalize.me/tutorial/get-token-oauth-2-requests).

Example:

Image

![Request a token using the authorization code grant](../assets/images/postman-post-oauth-token.png)

We will take the contents of the `token_type` and the `access_token` from the response above. Then we will concatenate the two pieces, separated by a space, obtaining `Bearer eyJ0eXAiO…WAJCRiw ...`. We will need to provide that string inside each request we want to authenticate whenever we use OAuth 2 for authentication. This is true regardless of the grant used to obtain the token.

The process will always be the same: grab the contents of `token_type` and concatenate it with the contents of `access_token` separated by a space. We will need to put this string inside a header called `Authorization`. Each different HTTP client has a different way of providing HTTP headers. Our consumer application will use an HTTP library to deal with these. Let's see how it looks when using [HTTPie](https://httpie.org).

```
http https://example.org/oauth/debug?_format=json 'Authorization:Bearer eyJ0eXAiO…WAJCRiw'
```

The access token above has been abbreviated for legibility.

The Simple OAuth Extras module, a submodule in Simple OAuth, provides the route `/oauth/debug?_format=json`. We will use this route to debug our access tokens, because it supports OAuth 2, and it responds with information about the user detected for that request.

```
{
  "id": "1",
  "token": [
    "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjQzMDM0M2YwOTY2YzYzYWNjZmRlZTI1ZTJiNGIzYzgzOWU5M2U2ZTM1YzU4Y2YxNTljMDM2NTcwMDY0OTAzMjFhYjIzZGVlYjAwM2RmZTNkIn0.eyJhdWQiOiI5MjYzMzZlOC1mZjFkLTRhODYtYWMyMy04YTdiOTFmOTkwMmUiLCJqdGkiOiI0MzAzNDNmMDk2NmM2M2FjY2ZkZWUyNWUyYjRiM2M4MzllOTNlNmUzNWM1OGNmMTU5YzAzNjU3MDA2NDkwMzIxYWIyM2RlZWIwMDNkZmUzZCIsImlhdCI6MTUwMzczMDA1NSwibmJmIjoxNTAzNzMwMDU1LCJleHAiOjE1MDM3MzAzNTUsInN1YiI6IjEiLCJzY29wZXMiOlsiYXV0aGVudGljYXRlZCIsImFub3RoZXJfZXhhbXBsZSIsImNvbnN1bWVyX2V4YW1wbGUiXX0.s-WgQLtP8ezS4XEeTmPyabasGXi5WxLkRlWBbrqYE91RIsHlH_aUuufkBkoUytvf6wbthHer5fd7Yb4bRgDvSw8mbkntOhRdg30sCIjhOBSCngQdrpf_6iS72Z7LR2VOMAG41waBO5pEIukvlroNHrAqeUPfEKFXk5CKWAJCRiw"
  ],
  "roles": [
    "authenticated",
    "another_example",
    "consumer_example"
  ],
  "permissions": {
    "access administration pages": {
      "access": true,
      "title": "Use the administration pages and help"
    },
    "…": "…",
    "view the administration theme": {
      "access": true,
      "title": "View the administration theme"
    }
  }
}
```

Given that we set up the access tokens to be short-lived it is possible that by the time we are debugging them, they are already expired. If that happens, the user will not be authenticated and the anonymous user will be matched instead.

In other words, a client should exchange the authorization code for an OAuth access token. It could also use [any other grant](https://oauth2.thephpleague.com/authorization-server/which-grant/) to obtain the token. For instance, single page applications tend to use the [implicit grant](https://www.youtube.com/watch?v=sZbzcCXMmEA). The consumer should then store the token, in its local storage. Future requests use that stored token rather than having to retrieve a new one each time. This same token can be reused for multiple requests, until it expires. At that point you can request a new one using the refresh token grant, or start over if the refresh token is also expired.

## Recap

In this tutorial we learned that Drupal provides Authentication API. This will allow custom and contributed modules to declare new authentication providers. We also learned that whatever route we are requesting needs to support the intended authentication provider. Finally, we learned to make authenticated requests using the access tokens obtained in the [previous tutorial](https://drupalize.me/tutorial/get-token-oauth-2-requests) using the `Authorization` header.

## Further your understanding

- Can you make an authenticated request that retrieves a node or other content entity?
- How would you create a route that supports all the available authentication providers? The [JSON:API module does it](https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/modules/jsonapi/src/Routing/Routes.php#L178).

## Additional resources

- [HTTPie](https://httpie.org) (httpie.org)
- [Which OAuth 2.0 grant should I implement?](https://oauth2.thephpleague.com/authorization-server/which-grant/) (oauth2.thephpleague.com)
- [Implicit Grant](https://www.youtube.com/watch?v=sZbzcCXMmEA) (youtube.com)
- [JSON:API's Routes.php](https://git.drupalcode.org/project/drupal/-/blob/10.1.x/core/modules/jsonapi/src/Routing/Routes.php#L178) (git.drupalcode.org)

Was this helpful?

Yes

No

Any additional feedback?

Previous
[Get a Token for OAuth 2 Requests](/tutorial/get-token-oauth-2-requests?p=3279)

Next
[Access an API from the Browser with Cross-Origin Resource Sharing](/tutorial/access-api-browser-cross-origin-resource-sharing?p=3279)

Clear History

Ask Drupalize.Me AI

close